services:
  # Векторная база данных
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag_qdrant
    restart: unless-stopped
    ports:
      - "6390:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage
    networks:
      - rag_network

  # Бэкенд-сервис RAG (LLM)
  rag-bot:
    build: ./rag-bot
    container_name: rag_bot_service
    restart: unless-stopped
    ports:
      - "8090:8000"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      # Proxy ---
      - HTTP_PROXY=http://host.docker.internal:20172
      - HTTPS_PROXY=http://host.docker.internal:20172
      - NO_PROXY=localhost,127.0.0.1,0.0.0.0,qdrant,rag-bot,rag-yandex-bot,rag-ingest,host.docker.internal,.ai.atomsk.ru,.dom.ru,192.168.42.11
    depends_on:
      - qdrant
    networks:
      - rag_network

  # Yandex Bot
  rag-yandex-bot:
    build: ./rag-yandex-bot
    container_name: rag_yandex_bot_service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - QDRANT_HOST=qdrant
      - RAG_BOT_ENDPOINT=http://rag-bot:8000/generate_answer
    depends_on:
      - rag-bot
      - qdrant
    networks:
      - rag_network

  # Data Ingestion (Run manually or on schedule, but defined here for environment context)
  # docker-compose run rag-ingest python ingest.py
  rag-ingest:
    build: ./rag-ingest
    container_name: rag_ingest_utility
    profiles: [ "tools" ]
    env_file:
      - .env
    environment:
      - QDRANT_HOST=qdrant
      - DOCS_DIR=/app/data
      # Proxy (если нужен для OpenRouter эмбеддингов)
      - HTTP_PROXY=http://host.docker.internal:20172
      - HTTPS_PROXY=http://host.docker.internal:20172
      - NO_PROXY=localhost,127.0.0.1,0.0.0.0,qdrant,rag-bot,rag-yandex-bot,rag-ingest,host.docker.internal,.ai.atomsk.ru,.dom.ru,192.168.42.11
    volumes:
      - ./data:/app/data
      - ingest_state:/app/state
    depends_on:
      - qdrant
    networks:
      - rag_network

volumes:
  ingest_state:

networks:
  rag_network:
    driver: bridge